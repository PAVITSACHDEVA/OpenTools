<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PDF Squeeze Pro Â· Lumix-Core</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body { background:#020617; font-family: Inter, system-ui, sans-serif; color:white; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
  const HISTORY_KEY = "lumix_history";

const loadHistory = () => {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
  catch { return []; }
};

const saveHistory = (items) => {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(items.slice(0, 50)));
};
setResults(prev => {
  const next = [...out, ...prev];
  saveHistory(next);
  return next;
});
const [queue, setQueue] = useState([]);
const [currentTask, setCurrentTask] = useState(null);
const [progressMap, setProgressMap] = useState({});

const { useState, useEffect, useRef } = React;
const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;
const enqueueFiles = (files, taskType) => {
  const tasks = files.map(f => ({
    id: crypto.randomUUID(),
    file: f,
    type: taskType,
    progress: 0
  }));
  setQueue(q => [...q, ...tasks]);
};

/* ================= ADMIN ================= */
const ROLE_MAP = {
  "1-D": "developer",
  "1-A": "admin",
  "1-T": "tester"
};

/* ================= ICON ================= */
const Icon = ({ name, size=16 }) => {
  useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
  return <i data-lucide={name} style={{ width:size, height:size }} />;
};

/* ================= APP ================= */
function App() {
  const [role, setRole] = useState(localStorage.getItem("lumix_role"));
  const [showLogin, setShowLogin] = useState(false);
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [queue, setQueue] = useState([]);
const [currentTask, setCurrentTask] = useState(null);
const [progressMap, setProgressMap] = useState({});

  const [activeTab, setActiveTab] = useState("rotate");
  const [files, setFiles] = useState([]);
  const [results, setResults] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);

  const fileRef = useRef(null);

  /* ===== LOGIN ===== */
  const login = () => {
    if (ROLE_MAP[password]) {
      localStorage.setItem("lumix_role", ROLE_MAP[password]);
      setRole(ROLE_MAP[password]);
      setShowLogin(false);
      setPassword("");
      setError("");
    } else setError("Invalid password");
  };

  const logout = () => {
    localStorage.removeItem("lumix_role");
    setRole(null);
  };

  /* ===== DRAG & DROP (FIXED) ===== */
  const onDrop = e => {
    e.preventDefault();
    e.stopPropagation();
    const pdfs = [...e.dataTransfer.files].filter(f => f.type === "application/pdf");
    if (pdfs.length) setFiles(prev => [...prev, ...pdfs]);
  };

  const block = e => {
    e.preventDefault();
    e.stopPropagation();
  };

  /* ===== ROTATE ===== */
  const [angle, setAngle] = useState(0);
  const rotatePDF = async () => {
    setIsProcessing(true);
    const out = [];
  const enqueueRotate = () => {
  const tasks = files.map(f => ({
    id: crypto.randomUUID(),
    type: "rotate",
    file: f
  }));
  setQueue(q => [...q, ...tasks]);
};

    setResults(prev => [...out, ...prev]);
    setIsProcessing(false);
  };
const rotateSingle = async (task) => {
  updateProgress(task.id, 10);

  const pdf = await PDFDocument.load(await task.file.arrayBuffer());
  updateProgress(task.id, 50);

  pdf.getPages().forEach(p => p.setRotation(degrees(angle)));
  updateProgress(task.id, 80);

  const bytes = await pdf.save();
  updateProgress(task.id, 100);

  setResults(prev => [
    makeResult(`rotated_${task.file.name}`, bytes),
    ...prev
  ]);
};
{Object.entries(progressMap).map(([id, value]) => (
  <div key={id} className="bg-slate-800 p-2 rounded-xl">
    <div className="h-1 bg-slate-700 rounded">
      <div
        className="h-1 bg-indigo-500 rounded"
        style={{ width: `${value}%` }}
      />
    </div>
  </div>
))}

  /* ===== WATERMARK ===== */
  const [wmText, setWmText] = useState("CONFIDENTIAL");
  const [wmColor, setWmColor] = useState("#888888");
  const [wmOpacity, setWmOpacity] = useState(0.4);
  const [wmAngle, setWmAngle] = useState(45);
  const [wmImage, setWmImage] = useState(null);

  const watermarkPDF = async () => {
    setIsProcessing(true);
    const out = [];

    for (const f of files) {
      const pdf = await PDFDocument.load(await f.arrayBuffer());
      const font = await pdf.embedFont(StandardFonts.HelveticaBold);

      let img = null;
      if (wmImage) {
        const buf = await wmImage.arrayBuffer();
        img = wmImage.type.includes("png")
          ? await pdf.embedPng(buf)
          : await pdf.embedJpg(buf);
      }

      const color = rgb(
        parseInt(wmColor.slice(1,3),16)/255,
        parseInt(wmColor.slice(3,5),16)/255,
        parseInt(wmColor.slice(5,7),16)/255
      );

      pdf.getPages().forEach(p => {
        const { width, height } = p.getSize();
        if (img) {
          p.drawImage(img, {
            x: width/4,
            y: height/4,
            width: img.width/2,
            height: img.height/2,
            opacity: wmOpacity,
            rotate: degrees(wmAngle)
          });
        }
        p.drawText(wmText, {
          x: width/4,
          y: height/2,
          size: 48,
          font,
          color,
          opacity: wmOpacity,
          rotate: degrees(wmAngle)
        });
      });

      out.push(makeResult(`watermarked_${f.name}`, await pdf.save()));
    }

    setResults(prev => [...out, ...prev]);
    setIsProcessing(false);
  };
useEffect(() => {
  // If nothing is processing and something is queued â†’ process next
  if (!currentTask && queue.length > 0) {
    const [next, ...rest] = queue;
    setQueue(rest);
    setCurrentTask(next);
    processTask(next);
  }
}, [queue, currentTask]);
const processTask = async (task) => {
  setIsProcessing(true);

  try {
    if (task.type === "rotate") {
      await rotateSingle(task);
    }
    if (task.type === "watermark") {
      await watermarkSingle(task);
    }
    if (task.type === "unlock") {
      await unlockSingle(task);
    }
  } catch (e) {
    console.error("Task failed:", e);
  } finally {
    setCurrentTask(null); // ðŸ‘ˆ allows next task to run
    setIsProcessing(false);
  }
};

  /* ===== RESULT ===== */
  const makeResult = (name, bytes) => ({
    id: Math.random().toString(36),
    name,
    url: URL.createObjectURL(new Blob([bytes], { type:"application/pdf" }))
  });

  return (
    <div className="max-w-6xl mx-auto p-6">

      {/* HEADER */}
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-black">PDF SQUEEZE PRO</h1>
        <div className="flex items-center gap-3">
          {role && <span className="text-xs uppercase text-indigo-400">{role}</span>}
          {!role && <button onClick={()=>setShowLogin(true)} className="text-xs">ADMIN</button>}
          {role && <button onClick={logout} className="text-xs">LOGOUT</button>}
        </div>
      </div>

      {/* TABS */}
      <div className="flex gap-2 mb-6">
        {["rotate","watermark","crush"].map(t=>(
          <button key={t} onClick={()=>setActiveTab(t)}
            className={`px-4 py-2 rounded-xl text-xs font-black uppercase
            ${activeTab===t?"bg-indigo-600":"bg-slate-800 text-slate-400"}`}>
            {t}
          </button>
        ))}
      </div>

      {/* DROPZONE */}
      <div
        onClick={()=>fileRef.current.click()}
        onDrop={onDrop}
        onDragOver={block}
        onDragEnter={block}
        className="border-2 border-dashed border-slate-700 p-12 rounded-3xl text-center cursor-pointer mb-6"
      >
        <input type="file" multiple accept="application/pdf" hidden ref={fileRef}
          onChange={e=>setFiles(prev=>[...prev, ...e.target.files])} />
        <Icon name="upload-cloud" size={32}/>
        <p className="mt-3 text-xs uppercase">{files.length} Files Selected</p>
      </div>

      {/* ROTATE */}
      {activeTab==="rotate" && (
        <div className="space-y-4">
          <input type="range" min="-360" max="360" value={angle}
            onChange={e=>setAngle(+e.target.value)} />
          <input type="number" value={angle}
            onChange={e=>setAngle(+e.target.value)}
            className="bg-slate-800 p-2 rounded-xl w-32"/>
          <button onClick={rotatePDF}
            className="bg-indigo-600 px-6 py-3 rounded-xl font-black">
            APPLY ROTATE
          </button>
        </div>
      )}

      {/* WATERMARK */}
      {activeTab==="watermark" && (
        <div className="space-y-3">
          <input value={wmText} onChange={e=>setWmText(e.target.value)}
            className="bg-slate-800 p-3 rounded-xl w-full"/>
          <input type="color" value={wmColor} onChange={e=>setWmColor(e.target.value)}/>
          <input type="range" min="0" max="1" step="0.05"
            value={wmOpacity} onChange={e=>setWmOpacity(+e.target.value)}/>
          <input type="range" min="0" max="360"
            value={wmAngle} onChange={e=>setWmAngle(+e.target.value)}/>
          <input type="file" accept="image/png,image/jpeg"
            onChange={e=>setWmImage(e.target.files[0])}/>
          <button onClick={watermarkPDF}
            className="bg-indigo-600 px-6 py-3 rounded-xl font-black">
            APPLY WATERMARK
          </button>
        </div>
      )}

      {/* CRUSH */}
      {activeTab==="crush" && (
        role==="admin" || role==="developer"
          ? <div className="bg-slate-900 p-10 rounded-3xl">CRUSH Â· ADMIN MODE (WIP)</div>
          : <div className="bg-slate-900 p-10 rounded-3xl">CRUSH Â· UNDER DEVELOPMENT</div>
      )}

      {/* RESULTS */}
      <div className="mt-10 space-y-3">
        {results.map(r=>(
          <a key={r.id} href={r.url} download={r.name}
            className="block bg-emerald-500 text-slate-950 p-4 rounded-xl font-black">
            DOWNLOAD {r.name}
          </a>
        ))}
      </div>

      {isProcessing && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center">
          <div className="w-12 h-12 border-4 border-t-indigo-500 rounded-full animate-spin"></div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>
